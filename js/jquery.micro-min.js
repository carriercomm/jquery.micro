/*


 jQuery Micro version 0.1.0-alpha

 Pico/Nano like editor for jquery

 http://micro.jcubic.pl

 Licensed under GNU GPL Version 3 license
 Copyright (c) 2013 Jakub Jankiewicz <http://jcubic.pl>

 Contain:
 sprintf.js: Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro>
 licensed under 3 clause BSD license

 Date: Sun, 18 Aug 2013 09:31:42 +0000
*/
(function(f){function l(b){return Object.prototype.toString.call(b).slice(8,-1).toLowerCase()}var j=function(){j.cache.hasOwnProperty(arguments[0])||(j.cache[arguments[0]]=j.parse(arguments[0]));return j.format.call(null,j.cache[arguments[0]],arguments)};j.format=function(b,d){var a=1,c=b.length,e="",h=[],i,k,g,m;for(i=0;i<c;i++){e=l(b[i]);if(e==="string")h.push(b[i]);else if(e==="array"){g=b[i];if(g[2]){e=d[a];for(k=0;k<g[2].length;k++){if(!e.hasOwnProperty(g[2][k]))throw j('[sprintf] property "%s" does not exist',
g[2][k]);e=e[g[2][k]]}}else e=g[1]?d[g[1]]:d[a++];if(/[^s]/.test(g[8])&&l(e)!="number")throw j("[sprintf] expecting number but found %s",l(e));switch(g[8]){case "b":e=e.toString(2);break;case "c":e=String.fromCharCode(e);break;case "d":e=parseInt(e,10);break;case "e":e=g[7]?e.toExponential(g[7]):e.toExponential();break;case "f":e=g[7]?parseFloat(e).toFixed(g[7]):parseFloat(e);break;case "o":e=e.toString(8);break;case "s":e=(e=String(e))&&g[7]?e.substring(0,g[7]):e;break;case "u":e>>>=0;break;case "x":e=
e.toString(16);break;case "X":e=e.toString(16).toUpperCase()}e=/[def]/.test(g[8])&&g[3]&&e>=0?"+"+e:e;k=g[4]?g[4]=="0"?"0":g[4].charAt(1):" ";m=g[6]-String(e).length;if(g[6]){for(var n=[];m>0;n[--m]=k);k=n.join("")}else k="";h.push(g[5]?e+k:k+e)}}return h.join("")};j.cache={};j.parse=function(b){for(var d=[],a=[],c=0;b;){if((d=/^[^\x25]+/.exec(b))!==null)a.push(d[0]);else if((d=/^\x25{2}/.exec(b))!==null)a.push("%");else if((d=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(b))!==
null){if(d[2]){c|=1;var e=[],h=d[2],i=[];if((i=/^([a-z_][a-z_\d]*)/i.exec(h))!==null)for(e.push(i[1]);(h=h.substring(i[0].length))!=="";)if((i=/^\.([a-z_][a-z_\d]*)/i.exec(h))!==null)e.push(i[1]);else if((i=/^\[(\d+)\]/.exec(h))!==null)e.push(i[1]);else throw"[sprintf] huh?";else throw"[sprintf] huh?";d[2]=e}else c|=2;if(c===3)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";a.push(d)}else throw"[sprintf] huh?";b=b.substring(d[0].length)}return a};f.sprintf=j;f.vsprintf=
function(b,d,a){a=d.slice(0);a.splice(0,0,b);return j.apply(null,a)}})(typeof exports!="undefined"?exports:window);
(function(f){function l(b,d){for(var a="",c=d;c--;)a+=b;return a}function j(b,d){this._root=f(b);this._letter=this._calculate_letter_size();this._root.addClass("micro");this._root.css({width:d.width,height:d.height});this._settings=d;this._title=f("<div/>").addClass("title").appendTo(this._root);this._set_file_name("");this._spacer=f("<div/>").addClass("spacer").appendTo(this._root);this._input=f("<input/>").appendTo(this._spacer);this._clipboard=f("<textarea/>").addClass("clipboard").appendTo(this._spacer);
this._table=f("<div/>").addClass("matrix");this.refresh();this._pointer={x:0,y:0};this._table.appendTo(this._root);this._footer=f("<div/>").addClass("footer").appendTo(this._root);this._message=f("<div/>").addClass("message").append("<span/>").appendTo(this._root).find("span");this._lines=[""];this._cursor_offset=this._page=this._offset=0;var a=this;this._input.bind("keydown.micro",function(c){if(a._focus){var e=a._lines[a._pointer.y],h=(e.match(/(\t)/g)||[]).length*3;if(c.which===37){a._pointer.x>
0&&a._set_pointer(a._pointer.x-1,a._pointer.y);c.preventDefault()}else if(c.which===38){a._pointer.y>0&&a._set_pointer(a._pointer.x,a._pointer.y-1);c.preventDefault()}else if(c.which===39){a._pointer.x<e.length-h&&a._set_pointer(a._pointer.x+1,a._pointer.y);c.preventDefault()}else if(c.which===40){a._pointer.y<a._lines.length-1&&a._set_pointer(a._pointer.x,a._pointer.y+1);c.preventDefault()}else if(c.which===35){a._set_pointer(e.length-h,a._pointer.y);c.preventDefault()}else if(c.which===36){a._set_pointer(0,
a._pointer.y);c.preventDefault()}else if(c.which===8)if(a._pointer.x===0){if(a._pointer.y>0){c=a._lines[a._pointer.y-1].length;a._lines[a._pointer.y-1]+=a._lines[a._pointer.y];a._lines=a._lines.slice(0,a._pointer.y).concat(a._lines.slice(a._pointer.y+1));a._set_pointer(c,a._pointer.y-1);a._view(a._offset)}}else if(a._pointer.x>0){c=a._pointer.x>e.length?e.length-h:a._pointer.x;a._lines[a._pointer.y]=e.slice(0,c-1)+e.slice(c,e.length);a._draw_cursor_line();a._set_pointer(c-1,a._pointer.y)}else{c=a._lines[a._pointer.y-
1];a._lines=a._lines.slice(0,a._pointer.y-1).concat(a._lines.slice(a._pointer.y));a._lines[a._pointer.y-1]=c+e;a._pointer.y--;a._pointer.x=c.length;a._set_pointer(a._pointer.x,a._pointer.y);a._view(a._offset)}else if(c.which===46)if(e.length===a._pointer.x){if(a._lines.length>a._pointer.y+1){a._lines[a._pointer.y]+=a._lines[a._pointer.y+1];a._lines=a._lines.slice(0,a._pointer.y+1).concat(a._lines.slice(a._pointer.y+2));a._view(a._offset)}}else{a._lines[a._pointer.y]=e.slice(0,a._pointer.x)+e.slice(a._pointer.x+
1,e.length);a._draw_cursor_line()}else if(c.which===13){c=e.slice(a._pointer.x);a._lines[a._pointer.y]=e.slice(0,a._pointer.x);a._lines=a._lines.slice(0,a._pointer.y+1).concat([c]).concat(a._lines.slice(a._pointer.y+1));a._set_pointer(0,a._pointer.y+1);a._view(a._offset)}console.log("pointer ["+a._pointer.x+" "+a._pointer.y+"]")}}).bind("keypress.micro",function(c){if(!c.ctrlKey){var e=String.fromCharCode(c.which);a.insert(e)}c.preventDefault()});f(document).bind("click.micro",function(c){c=f(c.target).parents(".micro");
c.length?c.data("micro").focus():a.blur()});this._table.on("click","span",function(){var c=f(this),e=a._offset+c.parents(".line").index(),h=c.index();c=a._lines[a._pointer.y];var i=a._get_cursor_offset();if(i>0&&a._pointer.y==e){var k=(c.match(/(\t)/g)||[]).length*3;h=i+h-1-k;if(h>c.length-k)h=c.length-k;a._set_pointer(h,e)}else{a._cursor_offset>0&&a._pointer.y!=e&&a._draw_line(a._pointer.y-a._offset,c);if(a._lines[e]){if(h>a._lines[e].length)h=a._lines[e].length;a._set_pointer(h,e)}}});d.enabled?
this.focus():this.blur()}j.prototype={insert:function(b){var d=b.split("\n"),a=this._lines[this._pointer.y],c=a.slice(this._pointer.x);console.log(this._pointer.x+" "+a.slice(0,this._pointer.x));this._lines[this._pointer.y]=a.slice(0,this._pointer.x)+d[0];if(d.length==1){this._lines[this._pointer.y]+=c;this._set_pointer(this._pointer.x+b.length,this._pointer.y);this._draw_cursor_line()}else{d[d.length-1]+=c;this._lines=this._lines.slice(0,this._pointer.y).contac(d.slice(1)).concat(this._lines.slice(this._pointer.y));
this._set_pointer(d[d.length-1].length,this._pointer.y+d.length-1)}},focus:function(){this._focus=true;this._table.find(".inactive").removeClass("inactive").css({width:"",height:""});this._input.focus()},blur:function(){this._focus=false;this._table.find(".cursor").addClass("inactive").css({width:this._letter.width-2,height:this._letter.height-2})},cols:function(){return this._cols},rows:function(){return this._rows},destroy:function(){this._root.removeData("micro").removeClass("micro");this._table.remove();
this._input.unbind(".micro");this._spacer.remove();this._footer.remove();this._message.remove();f(document).unbind(".micro")},refresh:function(){this._letter=this._calculate_letter_size();this._rows=Math.floor(this._root.height()/this._letter.height)-4;this._cols=Math.floor(this._root.width()/this._letter.width);this._matrix=[];this._table.empty();for(var b=0;b<this._rows;++b){var d=f("<div/>").addClass("line").appendTo(this._table);this._matrix[b]=[];for(var a=0;a<this._cols;++a){var c=f("<span>&nbsp;</span>").appendTo(d);
this._matrix[b][a]=c}}return this},set:function(b){this._lines=b.split("\n");this._set_pointer(0,0);this._view(0)},get:function(){return this._lines.join("\n")},_set_pointer:function(b,d){if(d>=this._lines.length)throw"[micro::_set_pointer]: Out of band";this._table.find(".cursor").removeClass("cursor");var a=Math.floor(this._rows/2),c=this._offset+this._rows-a;this.message("[ line "+(d+1)+"/"+this._lines.length+" ]");if(d-this._offset>=this._rows){a=d-c;if(this._offset!==c){this._pointer.x=b;this._pointer.y=
d;this._view(c)}}else if(d-this._offset<0){a=this._offset-this._rows+a;this._pointer.x=b;this._pointer.y=d;this._view(a);a=d-a}else a=d-c+a+1;c=(this._lines[d].match(/(\t)/g)||[]).length*3;if(b+c>=this._cols-1){this._pointer.x=b;this._pointer.y=d;this._draw_cursor_line()}else{this._pointer.x+c>=this._cols-1&&this._draw_line(this._pointer.y-this._offset,this._lines[this._pointer.y]);b>this._lines[d].length?this._matrix[a][this._lines[d].length].addClass("cursor"):this._matrix[a][b].addClass("cursor")}this._pointer.x=
b;this._pointer.y=d},_encode:function(b){return b.replace(" ","&nbsp;").replace("\t",l("&nbsp;",this._settings.tabStop))},_draw_line:function(b,d){var a=d.length>this._cols?this._cols:d.length,c;for(c=0;c<a;++c)this._matrix[b][c].html(this._encode(d[c]));a=(d.match(/(\t)/g)||[]).length*3;if(d.length+a>this._cols){this._matrix[b][this._cols-1-a].html("$");if(a>0)for(c=this._cols-a;c<this._cols;++c)this._matrix[b][c].html("&nbsp")}else for(c=d.length;c<this._cols;++c)this._matrix[b][c].html("&nbsp")},
_get_cursor_offset:function(){var b=(this._lines[this._pointer.y].match(/(\t)/g)||[]).length*3;return(this._cols-this._settings.horizontalMoveOffset-1)*Math.floor((this._pointer.x+b)/(this._cols-1))},_draw_cursor_line:function(){var b=this._pointer.y-this._offset,d=this._lines[this._pointer.y],a=(d.match(/(\t)/g)||[]).length*3;if(this._pointer.x+a>=this._cols-1)if(this._pointer.x+a>d.length)throw"[micro::_draw_cursor_line]: Out of bound";else{var c=this._get_cursor_offset();this._draw_line(b,"$"+
d.substring(c,c+this._cols));this._matrix[b][(this._pointer.x+a)%(this._cols-1)+this._settings.horizontalMoveOffset+1].addClass("cursor")}else this._draw_line(b,d)},_view:function(b){if(this._lines){this._offset=b;var d=this._lines.slice(b,b+this._rows),a=this._pointer.y-b;if(d[a].length>this._cols&&this._pointer.x>this._cols){console.log("_view -> x");for(b=0;b<a;++b)this._draw_line(b,d[b]);this._draw_cursor_line();for(b=a+1;b<d.length;++b)this._draw_line(b,d[b])}else f.each(d,this._draw_line.bind(this));
if(d.length<this._rows)for(b=d.length;b<this._rows;++b)this._draw_line(b,"")}return this},version:function(){return"0.1.0-alpha"},_set_file_name:function(b){var d="  jQuery Micro "+this.version();d+=l(" ",30-d.length)+f.micro.strings.file+": "+b;this._title.html(d.replace(/ /g,"&nbsp;"))},message:function(b){this._message.text(b)},open:function(b,d){var a=this;f.get(b,function(c){a._set_file_name(b);a._lines=c.split("\n");a._view(0);a._set_pointer(0,0);typeof d==="function"&&d()});return this},_calculate_letter_size:function(){var b=
f('<div class="micro"><div><span>&nbsp;</span></div></div>').appendTo("body"),d=b.find("span").width(),a=b.find("div").height();b.remove();return{width:d,height:a}}};f.micro={defaults:{enabled:true,tabStop:4,width:"100%",height:"400px",verticalMoveOffset:9,horizontalMoveOffset:6},strings:{file:"File",read:"Read %s Lines",chr:"line %d/%d (%d%%), col %d/%d (%d%%), char %d/%d (%d%%)"},init:j,fn:j.prototype};f.fn.micro=function(b){if(typeof b==="string"){var d=Array.prototype.slice.call(arguments);d.shift();
if(b[0]!=="_"&&typeof f.micro.fn[b]==="function")if(this.length==1){var a=f(this).data("micro");return f.micro.fn[b].apply(a,d)}else return f.each(this,function(){var e=f(this).data("micro");f.micro.fn[b].apply(e,d)});else return this}else{var c=f.extend({},f.micro.defaults,b);f.each(this,function(){f(this).data("micro",new f.micro.init(this,c))})}}})(jQuery);
