/*


 jQuery Micro version 0.0.1

 Pico/Nano like editor for jquery

 http://micro.jcubic.pl

 Licensed under GNU GPL Version 3 license
 Copyright (c) 2013 Jakub Jankiewicz <http://jcubic.pl>

 Date: Sun, 28 Jul 2013 19:52:44 +0000
*/
(function(e){function h(a,b){this._root=e(a);this._letter=this._calculate_letter_size();this._root.addClass("micro");this._root.css({width:b.width,height:b.height});this._settings=b;this._title=e("<div/>").addClass("title").appendTo(this._root);this._set_file_name("");e("<div>&nbsp;</div>").addClass("spacer").appendTo(this._root);this._table=e("<div/>").addClass("matrix");this.refresh();this._matrix=[];for(var c=0;c<this._rows;++c){var f=e("<div/>").addClass("line").appendTo(this._table);this._matrix[c]=
[];for(var i=0;i<this._cols;++i){var j=e("<span>&nbsp;</span>").appendTo(f);this._matrix[c][i]=j}}this._pointer={x:0,y:0};this._table.appendTo(this._root);this._footer=e("<div/>").addClass("footer").appendTo(this._root);this._message=e("<div/>").addClass("message").append("<span/>").appendTo(this._root).find("span");this._lines=[""];this._page=this._offset=0;this._set_pointer(0,0);var d=this;this._focus=b.enabled;e(document).bind("keydown.micro",function(g){if(d._focus)if(g.which===37)d._pointer.x>
0&&d._set_pointer(d._pointer.x-1,d._pointer.y);else if(g.which===38)d._pointer.y>0&&d._set_pointer(d._pointer.x,d._pointer.y-1);else if(g.which===39)d._pointer.x<d._lines[d._pointer.y].length&&d._set_pointer(d._pointer.x+1,d._pointer.y);else if(g.which===40)d._pointer.y<d._lines.length&&d._set_pointer(d._pointer.x,d._pointer.y+1);else if(g.which===35)d._set_pointer(d._lines[d._pointer.y].length,d._pointer.y);else g.which===36&&d._set_pointer(0,d._pointer.y)}).bind("click.micro",function(g){g=e(g.target).parents(".micro");
g.length?g.data("micro").focus(true):d.focus(false)})}h.prototype={focus:function(a){if(a===true||typeof a==="undefined"){this._focus=true;this._table.find(".cursor").removeClass("inactive").css({width:"",height:""})}else{this._focus=false;this._table.find(".cursor").addClass("inactive").css({width:this._letter.width-2,height:this._letter.height-2})}},destroy:function(){this._root.removeData("micro").removeClass("micro");this._table.remove();this._footer.remove();this._message.remove();e(document).unbind(".micro")},
refresh:function(){this._rows=Math.floor(this._root.height()/this._letter.height)-4;this._cols=Math.floor(this._root.width()/this._letter.width);return this},text:function(){return this._lines.join("\n")},page:function(){return Math.floor((this._offset+this._settings.verticalMoveOffset)/this._rows)},_set_pointer:function(a,b){if(b>=this._lines.length)throw"Out of band";this._table.find(".cursor").removeClass("cursor");var c;if(b>=this._rows){c=(this._rows-this._settings.verticalMoveOffset)*Math.floor(b/
(this._rows-1));this._offset!==c&&this._view(c);c=b%this._rows+this._settings.verticalMoveOffset}else if(b<=this._rows-this._settings.verticalMoveOffset-1&&this._offset!==0){this._pointer.x=a;this._pointer.y=b;this._view(0);c=b}else c=this._offset!==0?b-this._settings.verticalMoveOffset+1:b;if(a>=this._cols-1)if(a>this._lines[b].length)this._set_pointer(this._lines[b].length,b);else{this._pointer.x=a;this._pointer.y=b;this._draw_pointer_line()}else{this._pointer.x>=this._cols-1&&this._draw_line(this._pointer.y-
this._offset,this._lines[this._pointer.y]);a>this._lines[b].length?this._matrix[c][this._lines[b].length].addClass("cursor"):this._matrix[c][a].addClass("cursor")}this._pointer.x=a;this._pointer.y=b},_encode:function(a){return a.replace(" ","&nbsp;").replace("\t","&nbsp;&nbsp;&nbsp;&nbsp;")},_draw_line:function(a,b){var c=b.length>this._cols?this._cols:b.length,f;for(f=0;f<c;++f)this._matrix[a][f].html(this._encode(b[f]));if(b.length>this._cols)this._matrix[a][this._cols-1].html("$");else for(f=b.length;f<
this._cols;++f)this._matrix[a][f].html("&nbsp")},_draw_pointer_line:function(){var a=this._pointer.y-this._offset,b=this._lines[a];if(this._pointer.x>=this._cols-1)if(this._pointer.x>b.length)throw"Out of bound";else{var c=(this._cols-this._settings.horizontalMoveOffset-1)*Math.floor(this._pointer.x/(this._cols-1));this._draw_line(a,"$"+b.substring(c,c+this._cols));this._matrix[a][this._pointer.x%(this._cols-1)+this._settings.horizontalMoveOffset+1].addClass("cursor")}},_view:function(a){if(this._lines){this._offset=
a;var b=this._lines.slice(a,a+this._rows),c=this._pointer.y-a;if(b[c].length>this._cols&&this._pointer.x>this._cols){for(a=0;a<c;++a)this._draw_line(a,b[a]);for(a=c+1;a<b.length;++a)this._draw_line(a,b[a])}else e.each(b,this._draw_line.bind(this))}return this},version:function(){return"0.0.1"},_set_file_name:function(a){for(var b="  jQuery Micro "+this.version(),c="",f=30-b.length;f--;)c+=" ";b+=c+e.micro.strings.file+": "+a;this._title.html(b.replace(/ /g,"&nbsp;"))},message:function(a){this._message.text(a)},
open:function(a){var b=this;e.get(a,function(c){b._set_file_name(a);b._lines=c.split("\n");b._view(0)});return this},_calculate_letter_size:function(){var a=e('<div class="micro"><div><span>&nbsp;</span></div></div>').appendTo("body"),b=a.find("span").width(),c=a.find("div").height();a.remove();return{width:b,height:c}}};e.micro={defaults:{enabled:true,width:"100%",height:"400px",verticalMoveOffset:9,horizontalMoveOffset:6},strings:{file:"File"},init:h,fn:h.prototype};e.fn.micro=function(a){if(typeof a===
"string"){var b=Array.prototype.slice.call(arguments);b.shift();return a[0]!=="_"&&typeof e.micro.fn[a]==="function"?e.each(this,function(){var f=e(this).data("micro");e.micro.fn[a].apply(f,b)}):this}else{var c=e.extend({},e.micro.defaults,a);e.each(this,function(){e(this).data("micro",new e.micro.init(this,c))})}}})(jQuery);
