/*


 jQuery Micro version 0.1.0-alpha

 Pico/Nano like editor for jquery

 http://micro.jcubic.pl

 Licensed under GNU GPL Version 3 license
 Copyright (c) 2013 Jakub Jankiewicz <http://jcubic.pl>

 Contain:
 sprintf.js: Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro>
 licensed under 3 clause BSD license

 Date: Mon, 05 Aug 2013 20:14:09 +0000
*/
(function(f){function l(b){return Object.prototype.toString.call(b).slice(8,-1).toLowerCase()}var h=function(){h.cache.hasOwnProperty(arguments[0])||(h.cache[arguments[0]]=h.parse(arguments[0]));return h.format.call(null,h.cache[arguments[0]],arguments)};h.format=function(b,c){var a=1,d=b.length,e="",j=[],i,k,g,m;for(i=0;i<d;i++){e=l(b[i]);if(e==="string")j.push(b[i]);else if(e==="array"){g=b[i];if(g[2]){e=c[a];for(k=0;k<g[2].length;k++){if(!e.hasOwnProperty(g[2][k]))throw h('[sprintf] property "%s" does not exist',
g[2][k]);e=e[g[2][k]]}}else e=g[1]?c[g[1]]:c[a++];if(/[^s]/.test(g[8])&&l(e)!="number")throw h("[sprintf] expecting number but found %s",l(e));switch(g[8]){case "b":e=e.toString(2);break;case "c":e=String.fromCharCode(e);break;case "d":e=parseInt(e,10);break;case "e":e=g[7]?e.toExponential(g[7]):e.toExponential();break;case "f":e=g[7]?parseFloat(e).toFixed(g[7]):parseFloat(e);break;case "o":e=e.toString(8);break;case "s":e=(e=String(e))&&g[7]?e.substring(0,g[7]):e;break;case "u":e>>>=0;break;case "x":e=
e.toString(16);break;case "X":e=e.toString(16).toUpperCase()}e=/[def]/.test(g[8])&&g[3]&&e>=0?"+"+e:e;k=g[4]?g[4]=="0"?"0":g[4].charAt(1):" ";m=g[6]-String(e).length;if(g[6]){for(var n=[];m>0;n[--m]=k);k=n.join("")}else k="";j.push(g[5]?e+k:k+e)}}return j.join("")};h.cache={};h.parse=function(b){for(var c=[],a=[],d=0;b;){if((c=/^[^\x25]+/.exec(b))!==null)a.push(c[0]);else if((c=/^\x25{2}/.exec(b))!==null)a.push("%");else if((c=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(b))!==
null){if(c[2]){d|=1;var e=[],j=c[2],i=[];if((i=/^([a-z_][a-z_\d]*)/i.exec(j))!==null)for(e.push(i[1]);(j=j.substring(i[0].length))!=="";)if((i=/^\.([a-z_][a-z_\d]*)/i.exec(j))!==null)e.push(i[1]);else if((i=/^\[(\d+)\]/.exec(j))!==null)e.push(i[1]);else throw"[sprintf] huh?";else throw"[sprintf] huh?";c[2]=e}else d|=2;if(d===3)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";a.push(c)}else throw"[sprintf] huh?";b=b.substring(c[0].length)}return a};f.sprintf=h;f.vsprintf=
function(b,c,a){a=c.slice(0);a.splice(0,0,b);return h.apply(null,a)}})(typeof exports!="undefined"?exports:window);
(function(f){function l(b,c){for(var a="",d=c;d--;)a+=b;return a}function h(b,c){this._root=f(b);this._letter=this._calculate_letter_size();this._root.addClass("micro");this._root.css({width:c.width,height:c.height});this._settings=c;this._title=f("<div/>").addClass("title").appendTo(this._root);this._set_file_name("");this._spacer=f("<div/>").addClass("spacer").appendTo(this._root);this._input=f("<input/>").appendTo(this._spacer);this._clipboard=f("<textarea/>").addClass("clipboard").appendTo(this._spacer);
this._table=f("<div/>").addClass("matrix");this.refresh();this._pointer={x:0,y:0};this._table.appendTo(this._root);this._footer=f("<div/>").addClass("footer").appendTo(this._root);this._message=f("<div/>").addClass("message").append("<span/>").appendTo(this._root).find("span");this._lines=[""];this._cursor_offset=this._page=this._offset=0;var a=this;this._table.on("click","span",function(){var d=f(this),e=a._offset+d.parents(".line").index();d=d.index();if(!(a._cursor_offset>0))if(a._lines[e]){if(d>
a._lines[e].length)d=a._lines[e].length;a._set_pointer(d,e)}});this._input.bind("keydown.micro",function(d){if(a._focus){var e=a._lines[a._pointer.y],j=(e.match(/(\t)/g)||[]).length*3;console.log("pointer ["+a._pointer.x+" "+a._pointer.y+"]");if(d.which===37){a._pointer.x>0&&a._set_pointer(a._pointer.x-1,a._pointer.y);return false}else if(d.which===38){a._pointer.y>0&&a._set_pointer(a._pointer.x,a._pointer.y-1);return false}else if(d.which===39){a._pointer.x<a._lines[a._pointer.y].length&&a._set_pointer(a._pointer.x+
1,a._pointer.y);return false}else if(d.which===40){a._pointer.y<a._lines.length-1&&a._set_pointer(a._pointer.x,a._pointer.y+1);return false}else if(d.which===35){a._set_pointer(a._lines[a._pointer.y].length-j,a._pointer.y);return false}else if(d.which===36){a._set_pointer(0,a._pointer.y);return false}else if(d.which===8)if(a._pointer.x>0){d=a._pointer.x>e.length?e.length-j:a._pointer.x;a._lines[a._pointer.y]=e.slice(0,d-1)+e.slice(d,e.length);a._draw_cursor_line();a._set_pointer(d-1,a._pointer.y)}else{d=
a._lines[a._pointer.y-1];a._lines=a._lines.slice(0,a._pointer.y-1).concat(a._lines.slice(a._pointer.y));a._lines[a._pointer.y-1]=d+e;a._pointer.y--;a._pointer.x=d.length;a._set_pointer(a._pointer.x,a._pointer.y);a._view(a._offset)}else if(d.which===46){a._lines[a._pointer.y]=e.slice(0,a._pointer.x)+e.slice(a._pointer.x+1,e.length);a._draw_cursor_line()}else if(d.which===13){d=e.slice(a._pointer.x);a._lines[a._pointer.y]=e.slice(0,a._pointer.x);a._lines=a._lines.slice(0,a._pointer.y+1).concat([d]).concat(a._lines.slice(a._pointer.y+
1));a._set_pointer(0,a._pointer.y+1);a._view(a._offset)}}}).bind("keypress.micro",function(d){if(!d.ctrlKey){var e=String.fromCharCode(d.which);a.insert(e)}d.preventDefault()});f(document).bind("click.micro",function(d){d=f(d.target).parents(".micro");d.length?d.data("micro").focus(true):a.focus(false)});this.focus(c.enabled)}h.prototype={insert:function(b){var c=b.split("\n"),a=this._lines[this._pointer.y],d=a.slice(this._pointer.x);console.log(this._pointer.x+" "+a.slice(0,this._pointer.x));this._lines[this._pointer.y]=
a.slice(0,this._pointer.x)+c[0];if(c.length==1){this._lines[this._pointer.y]+=d;this._set_pointer(this._pointer.x+b.length,this._pointer.y);this._draw_cursor_line()}else{c[c.length-1]+=d;this._lines=this._lines.slice(0,this._pointer.y).contac(c.slice(1)).concat(this._lines.slice(this._pointer.y));this._set_pointer(c[c.length-1].length,this._pointer.y+c.length-1)}},focus:function(b){if(b===true||typeof b==="undefined"){this._focus=true;this._table.find(".inactive").removeClass("inactive").css({width:"",
height:""});this._input.focus()}else{this._focus=false;this._table.find(".cursor").addClass("inactive").css({width:this._letter.width-2,height:this._letter.height-2})}},destroy:function(){this._root.removeData("micro").removeClass("micro");this._table.remove();this._input.unbind(".micro");this._spacer.remove();this._footer.remove();this._message.remove();f(document).unbind(".micro")},refresh:function(){this._rows=Math.floor(this._root.height()/this._letter.height)-4;this._cols=Math.floor(this._root.width()/
this._letter.width);this._matrix=[];this._table.empty();for(var b=0;b<this._rows;++b){var c=f("<div/>").addClass("line").appendTo(this._table);this._matrix[b]=[];for(var a=0;a<this._cols;++a){var d=f("<span>&nbsp;</span>").appendTo(c);this._matrix[b][a]=d}}return this},text:function(){return this._lines.join("\n")},page:function(){return Math.floor((this._offset+this._settings.verticalMoveOffset)/this._rows)},_set_pointer:function(b,c){if(c>=this._lines.length)throw"Out of band";this._table.find(".cursor").removeClass("cursor");
var a=Math.floor(this._rows/2),d=this._offset+this._rows-a;this.message("[ line "+(c+1)+"/"+this._lines.length+" ]");if(c-this._offset>=this._rows){a=c-d;if(this._offset!==d){this._pointer.x=b;this._pointer.y=c;this._view(d)}}else if(c-this._offset<0){a=this._offset-this._rows+a;this._pointer.x=b;this._pointer.y=c;this._view(a);a=c-a}else a=c-d+a+1;d=(this._lines[c].match(/(\t)/g)||[]).length*3;if(b+d>=this._cols-1){console.log(1);this._pointer.x=b;this._pointer.y=c;this._draw_cursor_line()}else{console.log(3);
this._pointer.x+d>=this._cols-1&&this._draw_line(this._pointer.y-this._offset,this._lines[this._pointer.y]);b>this._lines[c].length?this._matrix[a][this._lines[c].length].addClass("cursor"):this._matrix[a][b].addClass("cursor")}this._pointer.x=b;this._pointer.y=c},_encode:function(b){return b.replace(" ","&nbsp;").replace("\t",l("&nbsp;",this._settings.tabStop))},_draw_line:function(b,c){var a=c.length>this._cols?this._cols:c.length,d;for(d=0;d<a;++d)this._matrix[b][d].html(this._encode(c[d]));a=
(c.match(/(\t)/g)||[]).length*3;if(c.length+a>this._cols){this._matrix[b][this._cols-1-a].html("$");if(a>0)for(d=this._cols-a;d<this._cols;++d)this._matrix[b][d].html("&nbsp")}else for(d=c.length;d<this._cols;++d)this._matrix[b][d].html("&nbsp")},_draw_cursor_line:function(){var b=this._pointer.y-this._offset,c=this._lines[this._pointer.y],a=(c.match(/(\t)/g)||[]).length*3;if(this._pointer.x+a>=this._cols-1)if(this._pointer.x+a>c.length)throw"Out of bound in _draw_cursor_line";else{var d=Math.floor((this._pointer.x+
a)/(this._cols-1)),e=(this._cols-this._settings.horizontalMoveOffset-1)*d;this._draw_line(b,"$"+c.substring(e,e+this._cols));c=(this._pointer.x+a)%(this._cols-1)+this._settings.horizontalMoveOffset+1;this._cursor_offset=this._settings.horizontalMoveOffset*d;console.log("offset: "+this._cursor_offset);this._matrix[b][c].addClass("cursor")}else this._draw_line(this._pointer.y-this._offset,c)},_view:function(b){if(this._lines){this._offset=b;var c=this._lines.slice(b,b+this._rows),a=this._pointer.y-
b;if(c[a].length>this._cols&&this._pointer.x>this._cols){console.log("_view -> x");for(b=0;b<a;++b)this._draw_line(b,c[b]);this._draw_cursor_line();for(b=a+1;b<c.length;++b)this._draw_line(b,c[b])}else f.each(c,this._draw_line.bind(this));if(c.length<this._rows)for(b=c.length;b<this._rows;++b)this._draw_line(b,"")}return this},version:function(){return"0.1.0-alpha"},_set_file_name:function(b){var c="  jQuery Micro "+this.version();c+=l(" ",30-c.length)+f.micro.strings.file+": "+b;this._title.html(c.replace(/ /g,
"&nbsp;"))},message:function(b){this._message.text(b)},open:function(b){var c=this;f.get(b,function(a){c._set_file_name(b);c._lines=a.split("\n");c._view(0);c._set_pointer(0,0)});return this},_calculate_letter_size:function(){var b=f('<div class="micro"><div><span>&nbsp;</span></div></div>').appendTo("body"),c=b.find("span").width(),a=b.find("div").height();b.remove();return{width:c,height:a}}};f.micro={defaults:{enabled:true,tabStop:4,width:"100%",height:"400px",verticalMoveOffset:9,horizontalMoveOffset:6},
strings:{file:"File",read:"Read %s Lines",chr:"line %d/%d (%d%%), col %d/%d (%d%%), char %d/%d (%d%%)"},init:h,fn:h.prototype};f.fn.micro=function(b){if(typeof b==="string"){var c=Array.prototype.slice.call(arguments);c.shift();return b[0]!=="_"&&typeof f.micro.fn[b]==="function"?f.each(this,function(){var d=f(this).data("micro");f.micro.fn[b].apply(d,c)}):this}else{var a=f.extend({},f.micro.defaults,b);f.each(this,function(){f(this).data("micro",new f.micro.init(this,a))})}}})(jQuery);
