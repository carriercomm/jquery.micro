/*


 jQuery Micro version 0.1.0-alpha

 Pico/Nano like editor for jquery

 http://micro.jcubic.pl

 Licensed under GNU GPL Version 3 license
 Copyright (c) 2013 Jakub Jankiewicz <http://jcubic.pl>

 Contain:
 sprintf.js: Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro>
 licensed under 3 clause BSD license

 Date: Sun, 04 Aug 2013 09:32:53 +0000
*/
(function(h){function l(c){return Object.prototype.toString.call(c).slice(8,-1).toLowerCase()}var b=function(){b.cache.hasOwnProperty(arguments[0])||(b.cache[arguments[0]]=b.parse(arguments[0]));return b.format.call(null,b.cache[arguments[0]],arguments)};b.format=function(c,d){var g=1,k=c.length,e="",a=[],f,i,j,m;for(f=0;f<k;f++){e=l(c[f]);if(e==="string")a.push(c[f]);else if(e==="array"){j=c[f];if(j[2]){e=d[g];for(i=0;i<j[2].length;i++){if(!e.hasOwnProperty(j[2][i]))throw b('[sprintf] property "%s" does not exist',
j[2][i]);e=e[j[2][i]]}}else e=j[1]?d[j[1]]:d[g++];if(/[^s]/.test(j[8])&&l(e)!="number")throw b("[sprintf] expecting number but found %s",l(e));switch(j[8]){case "b":e=e.toString(2);break;case "c":e=String.fromCharCode(e);break;case "d":e=parseInt(e,10);break;case "e":e=j[7]?e.toExponential(j[7]):e.toExponential();break;case "f":e=j[7]?parseFloat(e).toFixed(j[7]):parseFloat(e);break;case "o":e=e.toString(8);break;case "s":e=(e=String(e))&&j[7]?e.substring(0,j[7]):e;break;case "u":e>>>=0;break;case "x":e=
e.toString(16);break;case "X":e=e.toString(16).toUpperCase()}e=/[def]/.test(j[8])&&j[3]&&e>=0?"+"+e:e;i=j[4]?j[4]=="0"?"0":j[4].charAt(1):" ";m=j[6]-String(e).length;if(j[6]){for(var n=[];m>0;n[--m]=i);i=n.join("")}else i="";a.push(j[5]?e+i:i+e)}}return a.join("")};b.cache={};b.parse=function(c){for(var d=[],g=[],k=0;c;){if((d=/^[^\x25]+/.exec(c))!==null)g.push(d[0]);else if((d=/^\x25{2}/.exec(c))!==null)g.push("%");else if((d=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(c))!==
null){if(d[2]){k|=1;var e=[],a=d[2],f=[];if((f=/^([a-z_][a-z_\d]*)/i.exec(a))!==null)for(e.push(f[1]);(a=a.substring(f[0].length))!=="";)if((f=/^\.([a-z_][a-z_\d]*)/i.exec(a))!==null)e.push(f[1]);else if((f=/^\[(\d+)\]/.exec(a))!==null)e.push(f[1]);else throw"[sprintf] huh?";else throw"[sprintf] huh?";d[2]=e}else k|=2;if(k===3)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";g.push(d)}else throw"[sprintf] huh?";c=c.substring(d[0].length)}return g};h.sprintf=b;h.vsprintf=
function(c,d,g){g=d.slice(0);g.splice(0,0,c);return b.apply(null,g)}})(typeof exports!="undefined"?exports:window);
(function(h){function l(b,c){this._root=h(b);this._letter=this._calculate_letter_size();this._root.addClass("micro");this._root.css({width:c.width,height:c.height});this._settings=c;this._title=h("<div/>").addClass("title").appendTo(this._root);this._set_file_name("");h("<div>&nbsp;</div>").addClass("spacer").appendTo(this._root);this._table=h("<div/>").addClass("matrix");this.refresh();this._matrix=[];for(var d=0;d<this._rows;++d){var g=h("<div/>").addClass("line").appendTo(this._table);this._matrix[d]=
[];for(var k=0;k<this._cols;++k){var e=h("<span>&nbsp;</span>").appendTo(g);this._matrix[d][k]=e}}this._pointer={x:0,y:0};this._table.appendTo(this._root);this._footer=h("<div/>").addClass("footer").appendTo(this._root);this._message=h("<div/>").addClass("message").append("<span/>").appendTo(this._root).find("span");this._lines=[""];this._page=this._offset=0;var a=this;this._focus=c.enabled;h(document).bind("keydown.micro",function(f){if(a._focus){f.preventDefault();var i=a._lines[a._pointer.y];if(f.which===
37)a._pointer.x>0&&a._set_pointer(a._pointer.x-1,a._pointer.y);else if(f.which===38)a._pointer.y>0&&a._set_pointer(a._pointer.x,a._pointer.y-1);else if(f.which===39)a._pointer.x<a._lines[a._pointer.y].length&&a._set_pointer(a._pointer.x+1,a._pointer.y);else if(f.which===40)a._pointer.y<a._lines.length-1&&a._set_pointer(a._pointer.x,a._pointer.y+1);else if(f.which===35)a._set_pointer(a._lines[a._pointer.y].length,a._pointer.y);else if(f.which===36)a._set_pointer(0,a._pointer.y);else if(f.which===8)if(a._pointer.x>
0){f=a._pointer.x>i.length?i.length:a._pointer.x;a._lines[a._pointer.y]=i.slice(0,f-1)+i.slice(f,i.length);a._draw_cursor_line();a._set_pointer(f-1,a._pointer.y)}else{f=a._lines[a._pointer.y-1];a._lines=a._lines.slice(0,a._pointer.y-1).concat(a._lines.slice(a._pointer.y));a._lines[a._pointer.y-1]=f+i;a._pointer.y--;a._pointer.x=f.length;a._set_pointer(a._pointer.x,a._pointer.y);a._view(a._offset)}else if(f.which===46){a._lines[a._pointer.y]=i.slice(0,a._pointer.x)+i.slice(a._pointer.x+1,i.length);
a._draw_cursor_line()}else if(f.which===13){f=i.slice(a._pointer.x);a._lines[a._pointer.y]=i.slice(0,a._pointer.x);a._lines=a._lines.slice(0,a._pointer.y+1).concat([f]).concat(a._lines.slice(a._pointer.y+1));a._set_pointer(0,a._pointer.y+1);a._view(a._offset)}}}).bind("click.micro",function(f){f=h(f.target).parents(".micro");f.length?f.data("micro").focus(true):a.focus(false)})}l.prototype={focus:function(b){if(b===true||typeof b==="undefined"){this._focus=true;this._table.find(".cursor").removeClass("inactive").css({width:"",
height:""})}else{this._focus=false;this._table.find(".cursor").addClass("inactive").css({width:this._letter.width-2,height:this._letter.height-2})}},destroy:function(){this._root.removeData("micro").removeClass("micro");this._table.remove();this._footer.remove();this._message.remove();h(document).unbind(".micro")},refresh:function(){this._rows=Math.floor(this._root.height()/this._letter.height)-4;this._cols=Math.floor(this._root.width()/this._letter.width);return this},text:function(){return this._lines.join("\n")},
page:function(){return Math.floor((this._offset+this._settings.verticalMoveOffset)/this._rows)},_set_pointer:function(b,c){if(c>=this._lines.length)throw"Out of band";this._table.find(".cursor").removeClass("cursor");var d=Math.floor(this._rows/2),g=this._offset+this._rows-d;this.message("[ line "+(c+1)+"/"+this._lines.length+" ]");if(c-this._offset>=this._rows){d=c-g;if(this._offset!==g){this._pointer.x=b;this._pointer.y=c;this._view(g)}}else if(c-this._offset<0){g=this._offset-this._rows+d;this._pointer.x=
b;this._pointer.y=c;this._view(g);d=c-g}else d=c-g+d+1;if(b>=this._cols-1)if(b>this._lines[c].length)this._set_pointer(this._lines[c].length,c);else{this._pointer.x=b;this._pointer.y=c;this._draw_cursor_line()}else{this._pointer.x>=this._cols-1&&this._draw_line(this._pointer.y-this._offset,this._lines[this._pointer.y]);b>this._lines[c].length?this._matrix[d][this._lines[c].length].addClass("cursor"):this._matrix[d][b].addClass("cursor")}this._pointer.x=b;this._pointer.y=c},_encode:function(b){return b.replace(" ",
"&nbsp;").replace("\t","&nbsp;&nbsp;&nbsp;&nbsp;")},_string_length:function(b){var c=b.match(/(\t)/g);return c?b.length+c.length*3:b.length},_draw_line:function(b,c){var d=c.length>this._cols?this._cols:c.length,g;for(g=0;g<d;++g)this._matrix[b][g].html(this._encode(c[g]));d=(d=c.match(/(\t)/g))?d.length*3:0;if(c.length+d>this._cols)this._matrix[b][this._cols-1-d].html("$");else for(g=c.length;g<this._cols;++g)this._matrix[b][g].html("&nbsp")},_draw_cursor_line:function(){var b=this._pointer.y-this._offset,
c=this._lines[this._pointer.y];if(this._pointer.x>=this._cols-1)if(this._pointer.x>c.length)throw"Out of bound in _draw_cursor_line";else{var d=(this._cols-this._settings.horizontalMoveOffset-1)*Math.floor(this._pointer.x/(this._cols-1));this._draw_line(b,"$"+c.substring(d,d+this._cols));this._matrix[b][this._pointer.x%(this._cols-1)+this._settings.horizontalMoveOffset+1].addClass("cursor")}else this._draw_line(this._pointer.y,c)},_view:function(b){if(this._lines){this._offset=b;var c=this._lines.slice(b,
b+this._rows),d=this._pointer.y-b;if(c[d].length>this._cols&&this._pointer.x>this._cols){console.log("_view -> x");for(b=0;b<d;++b)this._draw_line(b,c[b]);this._draw_cursor_line();for(b=d+1;b<c.length;++b)this._draw_line(b,c[b])}else h.each(c,this._draw_line.bind(this));if(c.length<this._rows)for(b=c.length;b<this._rows;++b)this._draw_line(b,"")}return this},version:function(){return"0.1.0-alpha"},_set_file_name:function(b){for(var c="  jQuery Micro "+this.version(),d="",g=30-c.length;g--;)d+=" ";
c+=d+h.micro.strings.file+": "+b;this._title.html(c.replace(/ /g,"&nbsp;"))},message:function(b){this._message.text(b)},open:function(b){var c=this;h.get(b,function(d){c._set_file_name(b);c._lines=d.split("\n");c._view(0);c._set_pointer(0,0)});return this},_calculate_letter_size:function(){var b=h('<div class="micro"><div><span>&nbsp;</span></div></div>').appendTo("body"),c=b.find("span").width(),d=b.find("div").height();b.remove();return{width:c,height:d}}};h.micro={defaults:{enabled:true,width:"100%",
height:"400px",verticalMoveOffset:9,horizontalMoveOffset:6},strings:{file:"File",read:"Read %s Lines",chr:"line %d/%d (%d%%), col %d/%d (%d%%), char %d/%d (%d%%)"},init:l,fn:l.prototype};h.fn.micro=function(b){if(typeof b==="string"){var c=Array.prototype.slice.call(arguments);c.shift();return b[0]!=="_"&&typeof h.micro.fn[b]==="function"?h.each(this,function(){var g=h(this).data("micro");h.micro.fn[b].apply(g,c)}):this}else{var d=h.extend({},h.micro.defaults,b);h.each(this,function(){h(this).data("micro",
new h.micro.init(this,d))})}}})(jQuery);
